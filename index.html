<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>DDD Learner Improvement Interventions Tracker</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--teal:#0B8E8D;--teal-dk:#074445;--teal-lt:#E0F4F4;--teal-md:#4DB6AC;--green:#7AB648;--green-dk:#5FAD56;--green-lt:#E8F5E9;--orange:#E8952E;--orange-lt:#FFF3E0;--navy:#1A2332;--white:#FFF;--off:#F7F9FC;--grey:#607D8B;--grey-lt:#ECEFF1;--grey-dk:#37474F;--red:#E53935;--red-lt:#FFEBEE;--blue:#1565C0;--blue-lt:#E3F2FD}
body{font-family:'Segoe UI',system-ui,sans-serif;background:#f3f2f1;color:#323130;min-height:100vh}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.hdr{background:linear-gradient(135deg,#074445 0%,#0F7B7D 50%,#0A6B4F 100%);position:sticky;top:0;z-index:100}
.hdr-bar{height:4px;background:linear-gradient(90deg,var(--teal),var(--green),var(--orange))}
.hdr-content{display:flex;align-items:center;gap:12px;padding:10px 16px;max-width:720px;margin:0 auto}
.hdr-logo{height:48px;border-radius:6px}
.hdr-brand{font-size:10px;font-weight:600;letter-spacing:2px;color:#B8DCDC;text-transform:uppercase;margin-bottom:2px}
.hdr-title{font-size:16px;font-weight:700;color:white;line-height:1.2}
.hdr-sub{font-size:11px;color:#B8DCDC;margin-top:2px}
.hdr-titles{flex:1}
.hdr-user{display:flex;align-items:center;gap:8px}
nav.nav{display:flex;max-width:720px;margin:0 auto;border-top:1px solid rgba(255,255,255,.1)}
.nav-btn{flex:1;background:none;border:none;color:rgba(255,255,255,.6);font-size:12px;font-weight:600;padding:8px;cursor:pointer;font-family:inherit;transition:.2s;display:flex;align-items:center;justify-content:center;gap:6px}
.nav-btn.active{color:white;box-shadow:inset 0 -2px 0 var(--green)}
.nav-btn:hover{color:white}
.nav-icon{font-size:14px}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-wrap{max-width:640px;margin:0 auto;padding:16px 16px 40px}
.section{background:#fff;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,.08);margin-bottom:16px;overflow:hidden}
.sec-hdr{padding:14px 18px 8px;border-left:4px solid var(--teal);display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
.sec-hdr h2{font-size:15px;font-weight:600;color:#323130}
.sec-hdr p{font-size:11px;color:#605e5c;margin-top:2px}
.sec-hdr .arrow{font-size:14px;color:var(--grey);transition:transform .2s}
.sec-hdr .arrow.open{transform:rotate(180deg)}
.sec-hdr.green{border-color:var(--green)}
.sec-hdr.orange{border-color:var(--orange)}
.sec-hdr.blue{border-color:var(--blue)}
.sec-body{padding:4px 18px 16px}
.sec-body.collapsed{display:none}
.field{padding:10px 0;border-top:1px solid #f3f2f1}
.field:first-child{border-top:none}
.field label{display:block;font-size:13px;font-weight:600;color:#323130;margin-bottom:5px}
.field .hint{font-size:11px;color:#605e5c;margin-bottom:6px;font-weight:400}
.req{color:#a4262c;margin-left:2px}
.field select,.field input[type=text],.field input[type=date],.field input[type=number],.field input[type=url],.field textarea{width:100%;padding:8px 10px;border:1px solid #c8c6c4;border-radius:4px;font-size:13px;font-family:inherit;background:#fff;color:#323130}
.field select:focus,.field input:focus,.field textarea:focus{outline:none;border-color:var(--teal);box-shadow:0 0 0 1px var(--teal)}
.field textarea{resize:vertical;min-height:50px}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:500px){.field-row{grid-template-columns:1fr}}

/* Tags / Chips */
.tags{display:flex;flex-wrap:wrap;gap:6px}
.tag{display:flex;align-items:center;gap:4px;font-size:12px;padding:5px 10px;border:1px solid #e1dfdd;border-radius:4px;cursor:pointer;transition:.15s;font-weight:400}
.tag:hover{background:#f3f2f1}
.tag:has(input:checked){border-color:var(--teal);background:var(--teal-lt)}
.tag input:checked+span{color:var(--teal-dk);font-weight:500}
.tag input{display:none}
.tag-orange:has(input:checked){border-color:var(--orange);background:var(--orange-lt)}
.tag-orange input:checked+span{color:#E07B2A}
.tag-grp-title{font-size:11px;font-weight:600;color:#4A6B6B;display:flex;align-items:center;min-width:60px}

/* Radio group */
.radio-grp{display:flex;flex-direction:column;gap:5px}
.radio-grp label{display:flex;align-items:center;gap:8px;font-size:13px;padding:7px 10px;border:1px solid #e1dfdd;border-radius:4px;cursor:pointer;font-weight:400}
.radio-grp label:hover{background:#f3f2f1}
.radio-grp label:has(input:checked){border-color:var(--teal);background:var(--teal-lt)}

/* Buttons */
.btn{padding:10px 24px;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;border:none;font-family:inherit;transition:.15s}
.btn-teal{background:var(--teal);color:#fff}.btn-teal:hover{background:var(--teal-dk)}
.btn-outline{background:#fff;color:var(--teal);border:1px solid var(--teal)}.btn-outline:hover{background:var(--teal-lt)}
.btn-sm{padding:6px 14px;font-size:12px;border-radius:4px}
.btn:disabled{opacity:.5;cursor:not-allowed}
.form-submit{text-align:center;margin-top:8px}

/* Success */
.success{text-align:center;padding:40px 20px}
.success-icon{font-size:48px;margin-bottom:12px}
.success h2{font-size:22px;color:var(--teal-dk);margin-bottom:8px}
.success p{font-size:13px;color:var(--grey)}

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
.dash-wrap{max-width:720px;margin:0 auto;padding:16px 16px 40px}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
@media(max-width:500px){.stats-row{grid-template-columns:1fr 1fr}}
.stat-card{background:#fff;border-radius:8px;padding:14px;text-align:center;box-shadow:0 1px 3px rgba(0,0,0,.06);border-top:3px solid var(--teal)}
.stat-card.orange{border-color:var(--orange)}
.stat-card.green{border-color:var(--green)}
.stat-card.red{border-color:var(--red)}
.stat-num{font-size:28px;font-weight:800;color:var(--navy);line-height:1}
.stat-label{font-size:10px;font-weight:600;color:var(--grey);text-transform:uppercase;letter-spacing:.5px;margin-top:4px}

.dash-section{background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.06);margin-bottom:16px;overflow:hidden}
.dash-section-hdr{padding:14px 16px;border-bottom:1px solid var(--grey-lt);display:flex;justify-content:space-between;align-items:center}
.dash-section-hdr h3{font-size:14px;font-weight:700;color:var(--navy)}
.dash-section-body{padding:14px 16px}

/* Barrier bars */
.bar-chart{display:flex;flex-direction:column;gap:8px}
.bar-row{display:flex;align-items:center;gap:8px}
.bar-label{font-size:11px;color:var(--grey-dk);min-width:120px;text-align:right}
.bar-track{flex:1;height:20px;background:var(--grey-lt);border-radius:4px;overflow:hidden;position:relative}
.bar-fill{height:100%;border-radius:4px;display:flex;align-items:center;padding-left:6px;font-size:10px;font-weight:700;color:#fff;min-width:20px;transition:width .4s}
.bar-count{font-size:11px;color:var(--grey);min-width:24px;text-align:right}

/* Activity feed */
.feed-item{padding:12px 0;border-bottom:1px solid #f3f2f1;display:flex;gap:10px}
.feed-item:last-child{border-bottom:none}
.feed-dot{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0}
.feed-body{flex:1}
.feed-title{font-size:13px;font-weight:600;color:var(--navy)}
.feed-meta{font-size:11px;color:var(--grey);margin-top:2px}
.feed-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.feed-tag{font-size:10px;padding:2px 6px;border-radius:3px;background:var(--grey-lt);color:var(--grey-dk)}
.feed-tag.ctx{background:var(--orange-lt);color:#E07B2A}
.feed-tag.fup{background:var(--red-lt);color:var(--red)}

/* Follow-up list */
.fup-item{padding:10px 0;border-bottom:1px solid #f3f2f1;display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
.fup-item:last-child{border-bottom:none}
.fup-text{font-size:12px;color:var(--navy);flex:1}
.fup-date{font-size:11px;color:var(--grey);white-space:nowrap}
.fup-badge{font-size:10px;padding:2px 6px;border-radius:3px;background:var(--orange-lt);color:var(--orange);font-weight:600;white-space:nowrap}

/* Loading / Toast */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:50vh;gap:12px;color:var(--grey)}
.spinner{width:32px;height:32px;border:3px solid var(--grey-lt);border-top-color:var(--teal);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--navy);color:white;padding:10px 20px;border-radius:8px;font-size:13px;z-index:999;opacity:0;transition:opacity .3s}
.toast.show{opacity:1}
.fade-in{animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.empty{text-align:center;padding:32px;color:var(--grey);font-size:13px;font-style:italic}

/* Footer */
.footer{max-width:640px;margin:0 auto;padding:12px 16px;display:flex;align-items:center;gap:8px;border-top:2px solid var(--green)}
.footer span{font-size:10px;color:#7B8D9E}
.footer img{height:22px;border-radius:3px;opacity:.7}
</style>
</head>
<body>
<div id="app"></div>
<div class="toast" id="toast"></div>
<script src="./supabase.js"></script>
<script>
// Logo and config will be injected
const LOGO = "data:image/jpeg;base64,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";
const SUPA_URL = 'https://bqznmupkqsxxlyiiqrys.supabase.co';
const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxem5tdXBrcXN4eGx5aWlxcnlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzk2MDgwOTUsImV4cCI6MjA1NTE4NDA5NX0.jM54Wa9CExE5sHOTMFMmGUxgRn0OGxHSN9cPmrkFwMo';

// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
const DISTRICTS = {"Eastern Cape":["Alfred Nzo East","Alfred Nzo West","Amathole East","Amathole West","Buffalo City","Chris Hani East","Chris Hani West","Joe Gqabi","Nelson Mandela","O R Tambo Coastal","O R Tambo Inland","Sarah Baartman"],"Free State":["Fezile Dabi","Lejweleputswa","Mangaung Metro","Thabo Mofutsanyana","Xhariep"],"Gauteng":["Ekurhuleni North","Ekurhuleni South","Gauteng East","Gauteng North","Gauteng West","Johannesburg Central","Johannesburg East","Johannesburg North","Johannesburg South","Johannesburg West","Sedibeng East","Sedibeng West","Tshwane North","Tshwane South","Tshwane West"],"KwaZulu-Natal":["Amajuba","Harry Gwala","Ilembe","King Cetshwayo","Pinetown","Ugu","Umgungundlovu","Umkhanyakude","Umlazi","Umzinyathi","Uthukela","Zululand"],"Limpopo":["Capricorn North","Capricorn South","Mogalakwena","Mopani East","Mopani West","Sekhukhune East","Sekhukhune South","Vhembe East","Vhembe West","Waterberg"],"Mpumalanga":["Bohlabela","Ehlanzeni","Gert Sibande","Nkangala"],"North West":["Ditsobotla","Greater Taung","Jb Marks","Kagisano Molopo","Madibeng","Mahikeng","Maquassi Hills","Matlosana","Moretele","Moses Kotane","Naledi","Ramotshere Moiloa","Ratlou","Rustenburg","Tswaing"],"Northern Cape":["Frances Baard","John Taolo Gaetsewe","Namakwa","Pixley-Ka-Seme","Zf Mgcawu"],"Western Cape":["Cape Winelands","Eden And Central Karoo","Metro Central","Metro East","Metro North","Metro South","Overberg","Partnership Schools","West Coast"]};

const ACTIVITY_TYPES = ["School support visit","Workshop / training session","Mentoring session","Monitoring / follow-up visit","Data review meeting","Lesson observation","Saturday / extra classes","Holiday revision programme","Parent engagement meeting","District / circuit review meeting","Rapid Response session","Other"];
const THEMES = ["District Support","DBE Mentorship","Underperforming Schools","GET / Intermediate Phase","Senior Phase","Saturday / Extra Classes","Holiday Programme","Other"];
const DECISIONS = ["Target specific learners","Profile at-risk / progressed learners","Apply cohort-bottom or threshold analysis","Analyse SBA-exam deviation gap","Deploy subject support","Redesign lesson approach","Reallocate resources","Schedule extra classes","Set learner performance targets","Activate attendance monitoring plan","Sign academic support contracts","Engage parents/guardians","Escalate to management","Correct data quality","Other"];
const ACTIONS = ["Educator coaching / mentoring","Lesson modelling / demonstration","Subject improvement plan developed","Learner profiling & grouping","Academic support contract signed","Progressed learner agreement signed","Remedial scheduling","Extra lessons / revision classes","Past papers & worksheet packs distributed","Exam technique workshop conducted","Language / literacy support sessions","SBA target-setting with learners","Attendance monitoring plan activated","Resource / material provision","Differentiated teaching approach","Educator reassignment to subject","Parent meeting arranged","Term review meeting scheduled","Referral to SMT / DMT / PED","Data correction in SA-SAMS","School accountability discussion","Peer learning (school-to-school)","Performance monitoring report compiled","Other"];
const DDD_TOOLS = ["School Dashboard","Learner Chart Report","Promotion by Grade","Term to Date","FET Promotion Profiles","Senior Phase Promotion Profiles","Intermediate Phase Promotion Profiles","Term 4 Promotion Predictions","School Achievement Report","Grade 6 Performance Insights","Curriculum Overview","Management & Governance Overview","Over-age Learners","Educator Info","Other"];
const SUBJECTS = ["Mathematics","Mathematical Literacy","English HL","English FAL","Afrikaans HL","Afrikaans FAL","IsiZulu","IsiXhosa","Sepedi","Setswana","Sesotho","Life Sciences","Physical Sciences","Natural Sciences","Social Sciences","EMS","Business Studies","Accounting","Economics","Life Orientation","Life Skills","Technology","Geography","History","CAT","Tourism","Agricultural Sciences"];
const GRADES = ["R","1","2","3","4","5","6","7","8","9","10","11","12"];
const CTX_STAFFING = ["All posts filled","Vacant post(s)","Teaching outside specialisation","Acting principal/HoD","High educator absenteeism"];
const CTX_RESOURCES = ["Adequate","Textbook shortage","No devices/connectivity","Infrastructure issues","LTSM not delivered"];
const CTX_LEARNERS = ["No major concerns","High absenteeism","Welfare concerns","Overcrowded classrooms","Language barriers"];

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
const today = () => new Date().toISOString().slice(0,10);
const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const genId = p => p + '_' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);

const S = {
  loading:true, error:null, authState:'checking',
  official:{full_name:'User',role:'',province:'',district:'',email:''},
  view:'log', decisions:[], actions:[], outcomes:[], interventions:[],
  saving:false, submitted:false,
  openSections:{1:true,2:true,3:true,4:true},
  f: {
    province:'',district:'',schools:'',term:'Term 1 2026',activity_date:today(),
    activity_type:'',intervention_theme:'',subjects:[],grades:[],description:'',
    ddd_used:'',ddd_reports:[],data_insight:'',decision_type:'',action_type:'',action_other:'',
    ctx_staffing:[],ctx_resources:[],ctx_learners:[],ctx_notes:'',
    learners_reached:'',follow_up:false,follow_up_desc:'',
    doc_url:'',doc_name:''
  }
};

// ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ
const memStore = {};
const sb = window.supabase.createClient(SUPA_URL, SUPA_KEY, {
  auth: { storage: { getItem:k=>memStore[k]||null, setItem:(k,v)=>{memStore[k]=v}, removeItem:k=>{delete memStore[k]} }, flowType:'implicit', detectSessionInUrl:false }
});

async function checkAuth() {
  S.authState = 'ready';
  S.official = {full_name:'User',role:'',province:'',district:'',email:''};
  await loadAll();
  render();
}

async function loadAll() {
  try {
    const [d,a,o,iv] = await Promise.all([
      sb.from('decisions').select('*').order('created_at',{ascending:false}),
      sb.from('actions').select('*').order('created_at',{ascending:false}),
      sb.from('outcomes').select('*').order('created_at',{ascending:false}),
      sb.from('interventions').select('*').order('entity_name')
    ]);
    S.decisions = d.data||[]; S.actions = a.data||[]; S.outcomes = o.data||[]; S.interventions = iv.data||[];
    S.loading = false; S.error = null;
  } catch(e) { S.error = e.message; S.loading = false; }
  render();
}

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ
function render() {
  const app = document.getElementById('app');
  if (S.loading) { app.innerHTML = `<div class="loading"><div class="spinner"></div><div>Loading tracker...</div></div>`; return; }
  if (S.error) { app.innerHTML = `<div class="loading"><div style="font-size:48px">‚ö†Ô∏è</div><div style="color:var(--red)">${esc(S.error)}</div><button class="btn btn-teal btn-sm" onclick="S.loading=true;render();loadAll()">Retry</button></div>`; return; }

  const o = S.official;
  app.innerHTML = `
    <header class="hdr">
      <div class="hdr-bar"></div>
      <div class="hdr-content">
        <img class="hdr-logo" src="${LOGO}" alt="DDD Logo">
        <div class="hdr-titles">
          <div class="hdr-brand">DATA DRIVEN DISTRICTS</div>
          <div class="hdr-title">Learner Improvement Interventions Tracker</div>
          <div class="hdr-sub">Help us track how support is improving learner outcomes</div>
        </div>
      </div>
      <nav class="nav">
        <button class="nav-btn ${S.view==='log'?'active':''}" onclick="S.view='log';S.submitted=false;render()"><span class="nav-icon">‚úèÔ∏è</span>Log Activity</button>
        <button class="nav-btn ${S.view==='dashboard'?'active':''}" onclick="S.view='dashboard';render()"><span class="nav-icon">üìä</span>My Dashboard</button>
      </nav>
    </header>
    ${S.view === 'log' ? (S.submitted ? renderSuccess() : renderForm()) : renderDashboard()}
    <div class="footer">
      <img src="${LOGO}" alt="DDD">
      <span>Data Driven Districts Programme ¬∑ Department of Basic Education ¬∑ New Leaders Foundation</span>
    </div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderForm() {
  return `<div class="form-wrap">
    <p style="font-size:12px;color:var(--grey);margin-bottom:12px;text-align:center">This takes 3‚Äì5 minutes. Most fields are tap-to-select.</p>

    <!-- SECTION 1: Where & When -->
    <div class="section">
      ${secHdr(1,'‚ë† Where & When','Where and when did this activity happen?')}
      <div class="sec-body${S.openSections[1]?'':' collapsed'}" id="sec1">
        <div class="field-row">
          <div class="field"><label>Term<span class="req">*</span></label>
            <select onchange="S.f.term=this.value">${['Term 1 2026','Term 2 2026','Term 3 2026','Term 4 2026'].map(t=>`<option ${S.f.term===t?'selected':''}>${t}</option>`).join('')}</select>
          </div>
          <div class="field"><label>Date<span class="req">*</span></label><input type="date" value="${S.f.activity_date}" onchange="S.f.activity_date=this.value"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Province<span class="req">*</span></label>
            <select onchange="S.f.province=this.value;S.f.district='';render()">
              <option value="">Select province</option>
              ${Object.keys(DISTRICTS).map(p=>`<option ${S.f.province===p?'selected':''}>${p}</option>`).join('')}
            </select>
          </div>
          <div class="field"><label>District<span class="req">*</span></label>
            <select onchange="S.f.district=this.value">
              <option value="">Select district</option>
              ${(DISTRICTS[S.f.province]||[]).map(d=>`<option ${S.f.district===d?'selected':''}>${d}</option>`).join('')}
            </select>
          </div>
        </div>
        <div class="field"><label>School(s)<span class="req">*</span></label>
          <div class="hint">Names of schools involved</div>
          <input type="text" placeholder="e.g. Thuto Primary, Boitumelo Secondary" value="${esc(S.f.schools)}" oninput="S.f.schools=this.value">
        </div>
      </div>
    </div>

    <!-- SECTION 2: What Happened -->
    <div class="section">
      ${secHdr(2,'‚ë° What Happened','What type of activity and which subjects/grades?','green')}
      <div class="sec-body${S.openSections[2]?'':' collapsed'}" id="sec2">
        <div class="field-row">
          <div class="field"><label>Activity Type<span class="req">*</span></label>
            <select onchange="S.f.activity_type=this.value"><option value="">Select...</option>${ACTIVITY_TYPES.map(t=>`<option ${S.f.activity_type===t?'selected':''}>${t}</option>`).join('')}</select>
          </div>
          <div class="field"><label>Intervention Theme</label>
            <select onchange="S.f.intervention_theme=this.value"><option value="">Select...</option>${THEMES.map(t=>`<option ${S.f.intervention_theme===t?'selected':''}>${t}</option>`).join('')}</select>
          </div>
        </div>
        <div class="field"><label>Subject(s)</label><div class="hint">Tap all that apply</div>
          <div class="tags">${SUBJECTS.map(s=>`<label class="tag"><input type="checkbox" ${S.f.subjects.includes(s)?'checked':''} onchange="togArr(S.f.subjects,'${s}',this.checked)"><span>${s}</span></label>`).join('')}</div>
        </div>
        <div class="field"><label>Grade(s)</label><div class="hint">Tap all that apply</div>
          <div class="tags">${GRADES.map(g=>`<label class="tag"><input type="checkbox" ${S.f.grades.includes(g)?'checked':''} onchange="togArr(S.f.grades,'${g}',this.checked)"><span>Gr ${g}</span></label>`).join('')}</div>
        </div>
        <div class="field"><label>Brief description</label>
          <div class="hint">1‚Äì2 lines: what happened?</div>
          <textarea rows="2" placeholder="e.g. Modelled fractions teaching strategy with 3 Foundation Phase educators..." oninput="S.f.description=this.value">${esc(S.f.description)}</textarea>
        </div>
      </div>
    </div>

    <!-- SECTION 3: DDD Connection -->
    <div class="section">
      ${secHdr(3,'‚ë¢ DDD Data Connection','How did DDD data contribute to this activity?','blue')}
      <div class="sec-body${S.openSections[3]?'':' collapsed'}" id="sec3">
        <div class="field"><label>Was DDD data used?<span class="req">*</span></label>
          <div class="radio-grp">
            ${['Yes ‚Äî directly triggered this','Yes ‚Äî informed my approach','Partially','No'].map((v,i)=>{
              const val = ['yes-direct','yes-informed','partially','no'][i];
              return `<label><input type="radio" name="dddUsed" value="${val}" ${S.f.ddd_used===val?'checked':''} onchange="S.f.ddd_used=this.value;render()"><span>${v}</span></label>`;
            }).join('')}
          </div>
        </div>
        ${S.f.ddd_used && S.f.ddd_used !== 'no' ? `
          <div class="field"><label>Which DDD report(s)?</label>
            <div class="tags">${DDD_TOOLS.map(t=>`<label class="tag"><input type="checkbox" ${S.f.ddd_reports.includes(t)?'checked':''} onchange="togArr(S.f.ddd_reports,'${esc(t)}',this.checked)"><span>${t}</span></label>`).join('')}</div>
          </div>
          <div class="field"><label>What did the data show?</label>
            <textarea rows="2" placeholder="e.g. 42% of Grade 9 learners at Level 1‚Äì2 in Maths, concentrated in 3 schools..." oninput="S.f.data_insight=this.value">${esc(S.f.data_insight)}</textarea>
          </div>
        ` : ''}
        <div class="field-row">
          <div class="field"><label>Decision made</label>
            <select onchange="S.f.decision_type=this.value"><option value="">Select...</option>${DECISIONS.map(d=>`<option ${S.f.decision_type===d?'selected':''}>${d}</option>`).join('')}</select>
          </div>
          <div class="field"><label>Action taken<span class="req">*</span></label>
            <select onchange="S.f.action_type=this.value;render()"><option value="">Select...</option>${ACTIONS.map(a=>`<option ${S.f.action_type===a?'selected':''}>${a}</option>`).join('')}</select>
          </div>
        </div>
        ${S.f.action_type==='Other'?`<div class="field"><label>Describe action</label><textarea rows="2" placeholder="Describe..." oninput="S.f.action_other=this.value">${esc(S.f.action_other)}</textarea></div>`:''}
      </div>
    </div>

    <!-- SECTION 4: Context & Follow-up -->
    <div class="section">
      ${secHdr(4,'‚ë£ Context & Follow-up','Barriers, impact, and what happens next','orange')}
      <div class="sec-body${S.openSections[4]?'':' collapsed'}" id="sec4">
        <div class="field"><label>School context</label><div class="hint">Tap all that apply across schools visited</div>
          <div style="margin-bottom:8px"><span class="tag-grp-title">Staffing:</span>
            <div class="tags" style="display:inline-flex">${CTX_STAFFING.map(s=>`<label class="tag tag-orange"><input type="checkbox" ${S.f.ctx_staffing.includes(s)?'checked':''} onchange="togArr(S.f.ctx_staffing,'${s}',this.checked)"><span>${s}</span></label>`).join('')}</div>
          </div>
          <div style="margin-bottom:8px"><span class="tag-grp-title">Resources:</span>
            <div class="tags" style="display:inline-flex">${CTX_RESOURCES.map(s=>`<label class="tag tag-orange"><input type="checkbox" ${S.f.ctx_resources.includes(s)?'checked':''} onchange="togArr(S.f.ctx_resources,'${s}',this.checked)"><span>${s}</span></label>`).join('')}</div>
          </div>
          <div><span class="tag-grp-title">Learners:</span>
            <div class="tags" style="display:inline-flex">${CTX_LEARNERS.map(s=>`<label class="tag tag-orange"><input type="checkbox" ${S.f.ctx_learners.includes(s)?'checked':''} onchange="togArr(S.f.ctx_learners,'${s}',this.checked)"><span>${s}</span></label>`).join('')}</div>
          </div>
        </div>
        <div class="field"><label>Context note <span style="font-weight:400;color:var(--grey)">(optional)</span></label>
          <textarea rows="2" placeholder="e.g. No permanent Maths educator since Term 3 2025..." oninput="S.f.ctx_notes=this.value">${esc(S.f.ctx_notes)}</textarea>
        </div>
        <div class="field-row">
          <div class="field"><label>Learners reached</label><div class="hint">Approximate number impacted</div>
            <input type="number" placeholder="e.g. 120" min="0" value="${S.f.learners_reached}" oninput="S.f.learners_reached=this.value">
          </div>
          <div class="field"><label>Follow-up needed?</label>
            <div class="radio-grp">
              <label><input type="radio" name="fup" value="yes" ${S.f.follow_up?'checked':''} onchange="S.f.follow_up=true;render()"><span>Yes</span></label>
              <label><input type="radio" name="fup" value="no" ${!S.f.follow_up?'checked':''} onchange="S.f.follow_up=false;render()"><span>No</span></label>
            </div>
          </div>
        </div>
        ${S.f.follow_up ? `<div class="field"><label>Follow-up description</label>
          <textarea rows="2" placeholder="e.g. Return visit in 2 weeks to check implementation..." oninput="S.f.follow_up_desc=this.value">${esc(S.f.follow_up_desc)}</textarea>
        </div>` : ''}
        <div class="field"><label>üìé Supporting document <span style="font-weight:400;color:var(--grey)">(optional)</span></label>
          <div class="hint">Link to a relevant plan, report, or sign-in register</div>
          <input type="url" placeholder="Paste link (Google Drive, OneDrive, SharePoint...)" value="${esc(S.f.doc_url)}" oninput="S.f.doc_url=this.value" style="margin-bottom:6px">
          <input type="text" placeholder="Document name (e.g. Maths Improvement Plan)" value="${esc(S.f.doc_name)}" oninput="S.f.doc_name=this.value">
        </div>
      </div>
    </div>

    <div class="form-submit">
      <button class="btn btn-teal" onclick="submitForm()" ${S.saving?'disabled':''} style="min-width:200px">
        ${S.saving ? '<span class="spinner" style="width:18px;height:18px;border-width:2px;display:inline-block;vertical-align:middle"></span> Submitting...' : 'Submit ‚úì'}
      </button>
    </div>
  </div>`;
}

function secHdr(n, title, sub, color) {
  const open = S.openSections[n];
  return `<div class="sec-hdr ${color||''}" onclick="S.openSections[${n}]=!S.openSections[${n}];render()">
    <div><h2>${title}</h2><p>${sub}</p></div>
    <span class="arrow ${open?'open':''}">‚ñæ</span>
  </div>`;
}

function togArr(arr, val, add) {
  const i = arr.indexOf(val);
  if (add && i===-1) arr.push(val);
  if (!add && i!==-1) arr.splice(i,1);
}

function renderSuccess() {
  return `<div class="form-wrap"><div class="section"><div class="success fade-in">
    <div class="success-icon">‚úÖ</div>
    <h2>Thank you!</h2>
    <p>Your activity has been recorded. This helps us track how interventions improve learner outcomes ‚Äî and helps your district get the support it needs.</p>
    <div style="margin-top:16px;padding:14px;background:var(--teal-lt);border-radius:8px;text-align:left">
      <div style="font-size:11px;font-weight:700;color:var(--teal-dk);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">What you logged</div>
      <div style="font-size:12px;color:var(--navy);line-height:1.6">
        <strong>${esc(S.f.activity_type)}</strong> at <strong>${esc(S.f.schools)}</strong><br>
        ${S.f.district}, ${S.f.province} ¬∑ ${S.f.activity_date}<br>
        ${S.f.subjects.length ? 'Subjects: ' + S.f.subjects.join(', ') + '<br>' : ''}
        ${S.f.action_type ? 'Action: ' + esc(S.f.action_type) : ''}
        ${S.f.learners_reached ? ' ¬∑ ~' + S.f.learners_reached + ' learners' : ''}
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:20px">
      <button class="btn btn-teal" onclick="resetForm()">Log Another</button>
      <button class="btn btn-outline" onclick="S.view='dashboard';render()">View Dashboard</button>
    </div>
  </div></div></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FORM SUBMISSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function submitForm() {
  if (!S.f.province || !S.f.district || !S.f.schools) { showToast('Please complete Where & When'); return; }
  if (!S.f.activity_type) { showToast('Please select an activity type'); return; }
  if (!S.f.ddd_used) { showToast('Please indicate if DDD data was used'); return; }
  if (!S.f.action_type) { showToast('Please select an action taken'); return; }

  S.saving = true; render();

  const details = {
    province:S.f.province, district:S.f.district, schools:S.f.schools, term:S.f.term,
    activity_type:S.f.activity_type, intervention_theme:S.f.intervention_theme,
    subjects:S.f.subjects, grades:S.f.grades, description:S.f.description,
    ddd_used:S.f.ddd_used, ddd_reports:S.f.ddd_reports,
    decision_type:S.f.decision_type,
    ctx_staffing:S.f.ctx_staffing, ctx_resources:S.f.ctx_resources, ctx_learners:S.f.ctx_learners, ctx_notes:S.f.ctx_notes,
    learners_reached:S.f.learners_reached ? parseInt(S.f.learners_reached) : null,
    follow_up:S.f.follow_up, follow_up_desc:S.f.follow_up_desc
  };

  const decId = genId('DEC');
  const actId = genId('ACT');
  const meta = { logged_by:S.official.full_name||'User', logged_by_email:S.official.email||'' };

  try {
    // Insert decision
    const dec = {
      id: decId,
      intervention_id: S.interventions[0]?.id || null,
      ddd_tool: S.f.ddd_reports.join(', '),
      data_viewed: S.f.activity_type + ' ‚Äî ' + S.f.schools,
      insight: S.f.data_insight || S.f.description,
      decision_made: S.f.decision_type || S.f.activity_type,
      contextual_factors: [...S.f.ctx_staffing,...S.f.ctx_resources,...S.f.ctx_learners].join(', ') + (S.f.ctx_notes ? ' | ' + S.f.ctx_notes : ''),
      made_by: S.official.full_name || 'User',
      date: S.f.activity_date,
      details: details,
      ...meta
    };
    const r1 = await sb.from('decisions').insert(dec);
    if (r1.error) throw r1.error;

    // Insert action
    const act = {
      id: actId,
      decision_id: decId,
      intervention_id: dec.intervention_id,
      action_taken: S.f.action_type === 'Other' ? S.f.action_other : S.f.action_type,
      responsible: S.official.full_name || 'User',
      status: 'In Progress',
      target_date: null,
      notes: S.f.follow_up ? 'Follow-up: ' + S.f.follow_up_desc : '',
      supporting_doc_url: S.f.doc_url,
      supporting_doc_name: S.f.doc_name,
      ...meta
    };
    const r2 = await sb.from('actions').insert(act);
    if (r2.error) throw r2.error;

    S.submitted = true;
    await loadAll();
  } catch(e) {
    showToast('Error: ' + e.message);
  }
  S.saving = false; render();
  window.scrollTo({top:0,behavior:'smooth'});
}

function resetForm() {
  S.submitted = false;
  S.f = {
    province:S.f.province, district:S.f.district, schools:'', term:S.f.term, activity_date:today(),
    activity_type:'', intervention_theme:'', subjects:[], grades:[], description:'',
    ddd_used:'', ddd_reports:[], data_insight:'', decision_type:'', action_type:'', action_other:'',
    ctx_staffing:[], ctx_resources:[], ctx_learners:[], ctx_notes:'',
    learners_reached:'', follow_up:false, follow_up_desc:'',
    doc_url:'', doc_name:''
  };
  S.openSections = {1:true,2:true,3:true,4:true};
  render(); window.scrollTo({top:0,behavior:'smooth'});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const decs = S.decisions;
  const acts = S.actions;

  // Compute stats
  const totalActivities = decs.length;
  const schoolSet = new Set();
  let totalLearners = 0;
  let followUps = [];
  const barrierCounts = {};
  const activityByType = {};
  const dddUsageCounts = {direct:0,informed:0,partial:0,none:0};

  decs.forEach(d => {
    const det = d.details || {};
    if (det.schools) det.schools.split(',').forEach(s => schoolSet.add(s.trim()));
    if (det.learners_reached) totalLearners += det.learners_reached;
    if (det.follow_up && det.follow_up_desc) followUps.push({desc:det.follow_up_desc, date:d.date, schools:det.schools, district:det.district});
    
    // Count barriers
    (det.ctx_staffing||[]).forEach(b => { if(b!=='All posts filled') barrierCounts[b] = (barrierCounts[b]||0)+1; });
    (det.ctx_resources||[]).forEach(b => { if(b!=='Adequate') barrierCounts[b] = (barrierCounts[b]||0)+1; });
    (det.ctx_learners||[]).forEach(b => { if(b!=='No major concerns') barrierCounts[b] = (barrierCounts[b]||0)+1; });

    // Activity types
    if (det.activity_type) activityByType[det.activity_type] = (activityByType[det.activity_type]||0)+1;

    // DDD usage
    if (det.ddd_used==='yes-direct') dddUsageCounts.direct++;
    else if (det.ddd_used==='yes-informed') dddUsageCounts.informed++;
    else if (det.ddd_used==='partially') dddUsageCounts.partial++;
    else dddUsageCounts.none++;
  });

  const barriers = Object.entries(barrierCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const maxBarrier = barriers.length ? barriers[0][1] : 1;
  const actTypes = Object.entries(activityByType).sort((a,b)=>b[1]-a[1]).slice(0,6);
  const maxAct = actTypes.length ? actTypes[0][1] : 1;
  const dddTotal = totalActivities || 1;
  const dddPct = Math.round(((dddUsageCounts.direct+dddUsageCounts.informed)/dddTotal)*100);

  return `<div class="dash-wrap">
    <!-- STAT CARDS -->
    <div class="stats-row">
      <div class="stat-card"><div class="stat-num">${totalActivities}</div><div class="stat-label">Activities Logged</div></div>
      <div class="stat-card green"><div class="stat-num">${schoolSet.size}</div><div class="stat-label">Schools Visited</div></div>
      <div class="stat-card orange"><div class="stat-num">${totalLearners > 999 ? (totalLearners/1000).toFixed(1)+'k' : totalLearners}</div><div class="stat-label">Learners Reached</div></div>
      <div class="stat-card red"><div class="stat-num">${followUps.length}</div><div class="stat-label">Follow-ups Due</div></div>
    </div>

    <!-- DDD DATA USAGE -->
    <div class="dash-section">
      <div class="dash-section-hdr"><h3>üìä DDD Data Usage</h3><span style="font-size:24px;font-weight:800;color:var(--teal)">${dddPct}%</span></div>
      <div class="dash-section-body">
        <div style="display:flex;gap:4px;height:24px;border-radius:4px;overflow:hidden;margin-bottom:8px">
          <div style="width:${(dddUsageCounts.direct/dddTotal)*100}%;background:var(--teal);min-width:${dddUsageCounts.direct?'4px':'0'}"></div>
          <div style="width:${(dddUsageCounts.informed/dddTotal)*100}%;background:var(--teal-md);min-width:${dddUsageCounts.informed?'4px':'0'}"></div>
          <div style="width:${(dddUsageCounts.partial/dddTotal)*100}%;background:var(--orange);min-width:${dddUsageCounts.partial?'4px':'0'}"></div>
          <div style="width:${(dddUsageCounts.none/dddTotal)*100}%;background:var(--grey-lt);min-width:${dddUsageCounts.none?'4px':'0'}"></div>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:12px;font-size:11px;color:var(--grey)">
          <span>üü¢ Direct: ${dddUsageCounts.direct}</span>
          <span>üîµ Informed: ${dddUsageCounts.informed}</span>
          <span>üü† Partial: ${dddUsageCounts.partial}</span>
          <span>‚ö™ None: ${dddUsageCounts.none}</span>
        </div>
        <p style="font-size:11px;color:var(--grey);margin-top:8px">${dddPct}% of activities were directly triggered or informed by DDD data</p>
      </div>
    </div>

    <!-- CONTEXTUAL BARRIERS -->
    ${barriers.length ? `
    <div class="dash-section">
      <div class="dash-section-hdr"><h3>‚ö†Ô∏è Contextual Barriers Reported</h3></div>
      <div class="dash-section-body">
        <p style="font-size:11px;color:var(--grey);margin-bottom:10px">Most commonly reported challenges across school visits. These patterns help inform resource allocation decisions.</p>
        <div class="bar-chart">
          ${barriers.map(([label,count]) => `<div class="bar-row">
            <div class="bar-label">${esc(label)}</div>
            <div class="bar-track"><div class="bar-fill" style="width:${(count/maxBarrier)*100}%;background:var(--orange)">${count}</div></div>
          </div>`).join('')}
        </div>
      </div>
    </div>` : ''}

    <!-- ACTIVITY BREAKDOWN -->
    ${actTypes.length ? `
    <div class="dash-section">
      <div class="dash-section-hdr"><h3>üìã Activity Breakdown</h3></div>
      <div class="dash-section-body">
        <div class="bar-chart">
          ${actTypes.map(([label,count]) => `<div class="bar-row">
            <div class="bar-label">${esc(label)}</div>
            <div class="bar-track"><div class="bar-fill" style="width:${(count/maxAct)*100}%;background:var(--teal)">${count}</div></div>
          </div>`).join('')}
        </div>
      </div>
    </div>` : ''}

    <!-- FOLLOW-UPS DUE -->
    ${followUps.length ? `
    <div class="dash-section">
      <div class="dash-section-hdr"><h3>üîî Follow-ups Due</h3><span class="fup-badge">${followUps.length} pending</span></div>
      <div class="dash-section-body">
        ${followUps.slice(0,10).map(f => `<div class="fup-item">
          <div class="fup-text"><strong>${esc(f.schools||'')}</strong><br>${esc(f.desc)}</div>
          <div><div class="fup-date">${fmtDate(f.date)}</div>${f.district?`<div style="font-size:10px;color:var(--grey)">${esc(f.district)}</div>`:''}</div>
        </div>`).join('')}
      </div>
    </div>` : ''}

    <!-- RECENT ACTIVITY FEED -->
    <div class="dash-section">
      <div class="dash-section-hdr"><h3>üïê Recent Activity</h3></div>
      <div class="dash-section-body">
        ${decs.length === 0 ? '<div class="empty">No activities logged yet. Start by logging your first activity!</div>' :
          decs.slice(0,15).map(d => {
            const det = d.details || {};
            const allCtx = [...(det.ctx_staffing||[]),...(det.ctx_resources||[]),...(det.ctx_learners||[])].filter(c=>c!=='All posts filled'&&c!=='Adequate'&&c!=='No major concerns');
            const relActs = S.actions.filter(a=>a.decision_id===d.id);
            return `<div class="feed-item fade-in">
              <div class="feed-dot" style="background:${det.ddd_used&&det.ddd_used!=='no'?'var(--teal)':'var(--grey-lt)'}"></div>
              <div class="feed-body">
                <div class="feed-title">${esc(det.activity_type||d.decision_made||'Activity')}</div>
                <div class="feed-meta">
                  ${det.schools ? esc(det.schools) + ' ¬∑ ' : ''}${det.district||''} ¬∑ ${fmtDate(d.date)}
                  ${det.learners_reached ? ' ¬∑ ~'+det.learners_reached+' learners' : ''}
                </div>
                ${relActs.length ? `<div class="feed-meta" style="color:var(--navy)">Action: ${esc(relActs[0].action_taken)}</div>` : ''}
                <div class="feed-tags">
                  ${det.ddd_used&&det.ddd_used!=='no' ? '<span class="feed-tag" style="background:var(--teal-lt);color:var(--teal-dk)">DDD ‚úì</span>' : ''}
                  ${(det.subjects||[]).slice(0,3).map(s=>'<span class="feed-tag">'+esc(s)+'</span>').join('')}
                  ${allCtx.slice(0,2).map(c=>'<span class="feed-tag ctx">'+esc(c)+'</span>').join('')}
                  ${det.follow_up ? '<span class="feed-tag fup">Follow-up</span>' : ''}
                  ${relActs[0]?.supporting_doc_url ? '<span class="feed-tag">üìé Doc</span>' : ''}
                </div>
              </div>
            </div>`;
          }).join('')
        }
      </div>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ
function fmtDate(d) { if(!d)return'‚Äî'; try{return new Date(d).toLocaleDateString('en-ZA',{day:'numeric',month:'short',year:'numeric'})}catch(e){return d} }
function showToast(msg) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
checkAuth();
</script>
</body></html>
